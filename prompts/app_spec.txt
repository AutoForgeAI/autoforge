<project_specification>
  <project_name>Autocoder</project_name>

  <overview>
    Autocoder is a sophisticated autonomous coding platform that helps programmers and "vibe coders" build new applications or add code to existing projects. It orchestrates multiple AI coding agents in parallel, tracks feature progress via a Kanban board and dependency graph, integrates with development servers and Git, and provides real-time monitoring through WebSocket connections. The platform manages the entire development lifecycle from specification creation to deployment.
  </overview>

  <technology_stack>
    <frontend>
      <framework>React 19 + TypeScript</framework>
      <bundler>Vite 7.3.0</bundler>
      <styling>Tailwind CSS v4.1.0 + shadcn/ui + Radix UI</styling>
      <state_management>React Query (@tanstack/react-query v5.72.0)</state_management>
      <graph_visualization>@xyflow/react with dagre layout</graph_visualization>
      <terminal>xterm.js</terminal>
    </frontend>
    <backend>
      <runtime>Python 3.11+</runtime>
      <framework>FastAPI</framework>
      <orm>SQLAlchemy</orm>
      <database>SQLite</database>
    </backend>
    <communication>
      <api>REST API</api>
      <realtime>WebSocket</realtime>
      <proxy>Vite dev server proxies to FastAPI backend on port 8888</proxy>
    </communication>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Node.js 18+ and npm/pnpm
      - Python 3.11+ with pip
      - Git
      - Claude API key (for AI agents)
    </environment_setup>
  </prerequisites>

  <feature_count>123</feature_count>

  <security_and_access_control>
    <user_roles>
      <role name="developer">
        <permissions>
          - Full access to all projects
          - Start, stop, pause agents
          - Modify settings
          - Create and manage features
          - Access all views and tools
        </permissions>
        <protected_routes>
          - All routes accessible (single-user application)
        </protected_routes>
      </role>
    </user_roles>
    <authentication>
      <method>None (local development tool)</method>
      <session_timeout>None</session_timeout>
    </authentication>
    <sensitive_operations>
      - Reset project requires confirmation modal
      - Delete feature requires confirmation
      - Agent stop during active work shows warning
    </sensitive_operations>
  </security_and_access_control>

  <core_features>
    <infrastructure>
      - Database connection established
      - Database schema applied correctly
      - Data persists across server restart
      - No mock data patterns in codebase
      - Backend API queries real database
    </infrastructure>

    <project_management>
      - Create new project with name and path
      - Select project from dropdown
      - Switch between projects
      - Project registry stores paths
      - View project list
      - Delete project
      - Project settings persistence
      - Auto-select last used project
      - Project path validation
      - Multiple projects supported
      - Project-specific settings
      - Project initialization workflow
    </project_management>

    <feature_test_management>
      - Create feature with name, category, description, steps
      - Bulk create features via API
      - View features in Kanban board (3 or 4 columns)
      - View features in dependency graph
      - Edit feature details
      - Delete feature with confirmation
      - Mark feature as passing
      - Feature priority ordering
      - Feature categories (functional, style, infrastructure)
      - Feature dependencies (depends_on_indices)
      - Dependency visualization with graph
      - Feature progress tracking (passing count)
      - Feature status indicators (pending, in_progress, complete)
      - Feature filtering by status
      - Feature resume notes
      - Partial completion tracking
      - Click feature to view details
      - Drag-and-drop reordering (Kanban)
    </feature_test_management>

    <agent_orchestration>
      - Start coding agent
      - Stop coding agent
      - Pause agent execution
      - Resume paused agent
      - Graceful stop (finish current feature)
      - Multi-agent parallel execution
      - Agent count configuration (1-5 agents)
      - Agent status display (running, paused, stopped, crashed)
      - Agent mascot indicators per active agent
      - Real-time agent logs via WebSocket
      - Agent output in debug panel
      - Agent thought tracking
      - Feature assignment to agents
      - Agent crash detection and recovery
      - Auto-resume after crash
      - Lock file management
      - Process ID tracking
      - Agent Mission Control (orchestrator view)
      - Celebration animations on feature completion
      - Agent progress percentage display
    </agent_orchestration>

    <dev_server_integration>
      - Start development server
      - Stop development server
      - Dev server status indicator
      - Dev server port configuration
      - Dev server logs in debug panel
      - Auto-start dev server option
      - Dev server URL display
      - Kill orphan processes
    </dev_server_integration>

    <git_integration>
      - Git status display in header
      - Current branch indicator
      - Git worktree support for isolated agent work
      - Worktree creation per agent
      - Worktree cleanup
      - Commit tracking
      - Pull request creation support
      - Git diff viewing
      - Uncommitted changes indicator
      - Branch switching
    </git_integration>

    <settings_and_themes>
      - Global settings modal
      - Per-project settings
      - Theme selector (6 themes)
      - Dark mode toggle
      - Ollama mode toggle
      - GLM mode toggle
      - API key configuration
      - Model selection
      - Concurrent agent count
      - Settings persistence to localStorage
      - Settings sync to backend
      - Reset settings to defaults
    </settings_and_themes>

    <chat_ai_features>
      - Spec creation chat interface
      - Expand project chat
      - Assistant chat for help
      - Real-time chat via WebSocket
      - Chat message history
      - Chat session management
      - AI-powered spec generation
      - Feature suggestion from spec
      - Interactive project planning
      - Chat panel toggle
      - Multiple chat sessions
      - Chat reconnection on disconnect
      - Typing indicators
      - Message streaming
      - Error recovery in chat
    </chat_ai_features>

    <keyboard_shortcuts>
      - D: Toggle debug panel
      - T: Switch to testing view
      - N: New feature modal
      - E: Expand project
      - A: Agent Mission Control
      - , (comma): Open settings
      - G: Toggle graph/Kanban view
      - ?: Show keyboard help
      - R: Reset project (with confirmation)
      - Escape: Close modals
    </keyboard_shortcuts>

    <new_service_health_indicator>
      - Combined status icon in header (green/yellow/red)
      - Click to open status dropdown
      - Backend API health status
      - Backend API reconnect button
      - WebSocket connection status
      - WebSocket reconnect button
      - Agent process health status
      - Agent restart button
      - Status updates in real-time
      - Degraded state detection (yellow)
      - Error state detection (red)
      - All-healthy state (green)
    </new_service_health_indicator>

    <new_error_boundaries>
      - Error boundary for SpecCreationChat
      - Error boundary for AssistantChat
      - Error boundary for Terminal component
      - Error boundary for KanbanBoard
      - Graceful fallback UI on error
      - Retry button in error state
    </new_error_boundaries>

    <new_websocket_query_integration>
      - Feature updates invalidate React Query cache
      - Instant UI updates on WebSocket events
      - Reduced polling frequency when WebSocket connected
    </new_websocket_query_integration>
  </core_features>

  <database_schema>
    <tables>
      <features>
        - id (INTEGER, primary key, auto-increment)
        - project_name (TEXT, foreign key)
        - priority (INTEGER)
        - category (TEXT: functional, style, infrastructure)
        - name (TEXT)
        - description (TEXT)
        - steps (TEXT, JSON array)
        - passes (BOOLEAN, default false)
        - in_progress (BOOLEAN, default false)
        - depends_on (TEXT, JSON array of feature IDs)
        - resume_notes (TEXT, nullable)
        - partial_complete (BOOLEAN, default false)
        - created_at (TIMESTAMP)
        - updated_at (TIMESTAMP)
      </features>
      <projects>
        - name (TEXT, primary key)
        - path (TEXT)
        - created_at (TIMESTAMP)
        - settings (TEXT, JSON)
      </projects>
      <schedules>
        - id (INTEGER, primary key)
        - project_name (TEXT, foreign key)
        - schedule_type (TEXT)
        - schedule_config (TEXT, JSON)
        - enabled (BOOLEAN)
        - created_at (TIMESTAMP)
      </schedules>
    </tables>
  </database_schema>

  <api_endpoints_summary>
    <projects>
      - GET /api/projects/ - List all projects
      - POST /api/projects/ - Create project
      - GET /api/projects/{name} - Get project details
      - DELETE /api/projects/{name} - Delete project
      - PUT /api/projects/{name}/settings - Update project settings
    </projects>
    <features>
      - GET /api/projects/{name}/features/ - List features
      - POST /api/projects/{name}/features/ - Create feature
      - POST /api/projects/{name}/features/bulk - Bulk create features
      - GET /api/projects/{name}/features/{id} - Get feature
      - PUT /api/projects/{name}/features/{id} - Update feature
      - DELETE /api/projects/{name}/features/{id} - Delete feature
      - POST /api/projects/{name}/features/{id}/mark-passing - Mark as passing
      - GET /api/projects/{name}/features/stats - Get feature statistics
    </features>
    <agent>
      - GET /api/projects/{name}/agent/status - Agent status
      - POST /api/projects/{name}/agent/start - Start agent
      - POST /api/projects/{name}/agent/stop - Stop agent
      - POST /api/projects/{name}/agent/pause - Pause agent
      - POST /api/projects/{name}/agent/resume - Resume agent
      - POST /api/projects/{name}/agent/graceful-stop - Graceful stop
    </agent>
    <websocket>
      - WS /ws/projects/{name} - Project WebSocket (progress, logs, status)
      - WS /api/projects/{name}/assistant/ws - Assistant chat
      - WS /api/spec/chat/ws - Spec creation chat
      - WS /api/expand/chat/ws - Expand project chat
    </websocket>
    <health>
      - GET /api/health - Basic health check
      - GET /api/health/detailed - Detailed health (NEW: includes DB, agents, WebSocket)
    </health>
    <settings>
      - GET /api/settings/ - Get global settings
      - PUT /api/settings/ - Update global settings
    </settings>
    <git>
      - GET /api/projects/{name}/git/status - Git status
      - POST /api/projects/{name}/git/worktree - Create worktree
      - DELETE /api/projects/{name}/git/worktree - Delete worktree
    </git>
    <dev_server>
      - GET /api/projects/{name}/dev-server/status - Dev server status
      - POST /api/projects/{name}/dev-server/start - Start dev server
      - POST /api/projects/{name}/dev-server/stop - Stop dev server
    </dev_server>
  </api_endpoints_summary>

  <ui_layout>
    <main_structure>
      - Sticky header with logo, controls, and status indicators
      - Main content area with Kanban board or Dependency graph
      - Resizable debug panel at bottom
      - Floating assistant chat panel
      - Modal overlays for settings, features, confirmations
    </main_structure>
    <header_layout>
      - Left: Logo "AutoCoder" + version badge
      - Center-Right: ProjectSelector, AgentControl, DevServerControl, ServiceHealthIndicator (NEW), Settings, Reset, GitStatusBar
      - Far Right: ThemeSelector, Dark mode toggle
    </header_layout>
    <kanban_layout>
      - 3 or 4 column layout (configurable)
      - Columns: Backlog, In Progress, Testing, Complete
      - Scrollable columns with fixed height
      - Feature cards with status, category, progress
    </kanban_layout>
    <graph_layout>
      - Interactive node-based visualization
      - Nodes represent features
      - Edges represent dependencies
      - Color-coded by status
      - Zoom and pan controls
    </graph_layout>
  </ui_layout>

  <design_system>
    <color_palette>
      - 6 themes available: Default, Ocean, Forest, Sunset, Midnight, Lavender
      - Each theme has light and dark variants
      - Primary, secondary, accent, muted colors per theme
      - Status colors: green (success), yellow (warning), red (error), blue (info)
    </color_palette>
    <typography>
      - System font stack for UI
      - Monospace for code and logs
      - Font sizes: xs, sm, base, lg, xl, 2xl
    </typography>
    <components>
      - shadcn/ui component library
      - Radix UI primitives for accessibility
      - Custom components built on primitives
    </components>
  </design_system>

  <implementation_steps>
    <step number="1">
      <title>Service Health Indicator Component</title>
      <tasks>
        - Create useServiceHealth hook combining API, WebSocket, and Agent health
        - Create ServiceHealthIndicator component with dropdown
        - Add to header after DevServerControl
        - Implement reconnect/restart action handlers
        - Add combined status color logic (green/yellow/red)
      </tasks>
    </step>
    <step number="2">
      <title>Enhanced Health Endpoint</title>
      <tasks>
        - Extend /api/health to include database status
        - Add WebSocket connection count
        - Add running agent count
        - Add uptime information
        - Create /api/health/detailed endpoint
      </tasks>
    </step>
    <step number="3">
      <title>Error Boundaries</title>
      <tasks>
        - Create reusable ErrorBoundary component with retry
        - Wrap SpecCreationChat
        - Wrap AssistantChat
        - Wrap Terminal
        - Wrap KanbanBoard
      </tasks>
    </step>
    <step number="4">
      <title>WebSocket-Query Integration</title>
      <tasks>
        - Add queryClient access in useWebSocket hook
        - Invalidate features query on feature_update message
        - Invalidate agent status on agent_status message
        - Reduce polling interval when WebSocket connected
      </tasks>
    </step>
    <step number="5">
      <title>Testing and Polish</title>
      <tasks>
        - Test all health indicator states
        - Test reconnection flows
        - Test error boundary recovery
        - Verify instant updates via WebSocket
        - Performance testing
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - All 123 features passing
      - Service health indicator shows accurate status
      - Reconnect/restart buttons work correctly
      - Error boundaries catch and recover from errors
      - WebSocket updates trigger instant UI refresh
    </functionality>
    <user_experience>
      - Clear visual feedback for connection status
      - One-click service recovery
      - Graceful degradation when services unavailable
      - No jarring error screens (error boundaries)
    </user_experience>
    <technical_quality>
      - No console errors in normal operation
      - Proper error handling throughout
      - Clean component architecture
      - Efficient re-renders (memoization where needed)
    </technical_quality>
    <design_polish>
      - Consistent with existing UI style
      - Smooth transitions and animations
      - Accessible (keyboard nav, screen readers)
      - Responsive across screen sizes
    </design_polish>
  </success_criteria>

  <improvement_recommendations>
    <recommendation priority="1">
      <title>Add Error Boundaries Throughout the App</title>
      <description>Only DependencyGraph has an error boundary. Wrap SpecCreationChat, AssistantChat, Terminal, and KanbanBoard in error boundaries to prevent cascading failures and improve reliability.</description>
    </recommendation>
    <recommendation priority="2">
      <title>Connect WebSocket Updates to React Query</title>
      <description>Features are polled every 5 seconds via React Query, but WebSocket already sends feature_update messages that aren't being used. Invalidate React Query cache on WebSocket events for instant updates.</description>
    </recommendation>
    <recommendation priority="3">
      <title>Refactor App.tsx State Management</title>
      <description>App.tsx is 666 lines with 17+ pieces of state. Extract keyboard shortcuts into useKeyboardShortcuts hook, consolidate modal/panel state into a reducer or Zustand store, and split header into its own component.</description>
    </recommendation>
  </improvement_recommendations>
</project_specification>
